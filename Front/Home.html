<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Тестирование экстрасенсов</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>

  <center id="hide" style="display: "><h5>Дорогой пользователь, тебе необходимо загадать 2х значное положительное число. </h5>
   <h5>После того, как будешь готов, нажми кнопку нижу: &darr;</h5></center>
  <div class="container mt-4">
    <div class="text-center">
      <button id="start" class="btn btn-primary" style="display: ">Загадал</button>
    </div>

    <div id="DOVOD" style="display:none">
    </br><center><h3>Догадки экстрасенсов</h3></center>
    <div class="row mt-4">
      <div class="col">
        <table id="predict-table" class="table">
          <tr>
            <td>Экстрасенс 1</td>
            <td>Экстрасенс 2</td>
            <td>Экстрасенс 3</td>
            <td>Экстрасенс 4</td>
            <td>Экстрасенс 5</td>
          </tr>
          <tr>
            <td>Его предположение</td>
            <td>Его предположение</td>
            <td>Его предположение</td>
            <td>Его предположение</td>
            <td>Его предположение</td>
          </tr>
        </table>
      </div>
    </div>
  </div>

<div id="TRACER" style="display:none">
</br><center><h3>Разрешить спор экстрасенсов</h3></center>
    <div class="row">
      <div class="col-md-6">
        <input id="inp" type="number" min="10" max="99" class="form-control" placeholder="Введите задуманное положительное двухзначное число">
      </div>
      <div class="col-md-6">
        <button id="answer" class="btn btn-primary">Ответить</button>
      </div>
      <label style="color:#FF0000" id="ErrorLabel"></label>
    </div>
  </div>

</br><div class="text-center" id="povtor" style="display:none">
    <center><h5>Сыграть ещё раз?</h5> </br> 
    <label>Необходимо загадать двухзначное положительное число :)</label></center>
    <button id="start2" class="btn btn-primary">Загадал</button>
  </div>

<div id="dostov" style="display:none">
</br><center><h3>Достоверность экстрасенсов</h3></center>
    <div class="row mt-4">
      <div class="col">
        <table id="result-table" class="table">
          <tr>
            <td>Экстрасенс 1</td>
            <td>Экстрасенс 2</td>
            <td>Экстрасенс 3</td>
            <td>Экстрасенс 4</td>
            <td>Экстрасенс 5</td>
          </tr>
          <tr>
            <td>0</td>
            <td>0</td>
            <td>0</td>
            <td>0</td>
            <td>0</td>
          </tr>
        </table>
      </div>
    </div>
  </div>

  <div id="history" style="display:none">
</br><center><h3>История догадок экстрасенсов</h3></center>
    <div class="row mt-4">
      <div class="col">
        <table id="dynamic-hystory-table" class="table">
          <tr>
            <td>Экстрасенс 1</td>
            <td>Экстрасенс 2</td>
            <td>Экстрасенс 3</td>
            <td>Экстрасенс 4</td>
            <td>Экстрасенс 5</td>
            <td>Загаданное число</td>
          </tr>
        </table>
      </div>
    </div>
  </div>
  </div>

  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <script>
    window.addEventListener('DOMContentLoaded', async function() {
      const response = await fetch("http://127.0.0.1:8080/Session", {
                method: "GET",
                headers: { "Accept": "application/json", "Content-Type": "application/json" }
            });
    if (response.ok === true) {
        const message = await response.json();
        var token = message['jwt']
        console.log("Токен получен")
        window.localStorage.setItem('Token', token);
    }
  });

  document.getElementById("start").addEventListener("click", e => {
    e.preventDefault();
    getPrediction();
    document.getElementById("TRACER").style.display = '';
    document.getElementById("DOVOD").style.display = '';
    document.getElementById("history").style.display = 'none';
    document.getElementById("start").style.display = 'none';
    document.getElementById("hide").style.display = 'none';
    document.getElementById("povtor").style.display = 'none';
  })

  document.getElementById("start2").addEventListener("click", e => {
    e.preventDefault();
    getPrediction();
    document.getElementById("povtor").style.display = 'none';
    document.getElementById("TRACER").style.display = '';
  })

  document.getElementById("answer").addEventListener("click", e => {
    e.preventDefault();
    var s = document.getElementById("inp");
    var n = s.value;
    var c = check(n)
    if (c === true) {
      getResult(n);
      document.getElementById('inp').value = ''
      document.getElementById("povtor").style.display = '';
      document.getElementById("dostov").style.display = '';
      document.getElementById("TRACER").style.display = 'none';
      document.getElementById("history").style.display = '';
    }
  })

function check(number) {
  var x = parseInt(number, 10);
  if (isNaN(x)) {
    showError("ErrorLabel", "Вы не ввели число")
    return false
  }
  if (x > 9 && x < 100) {
    showError("ErrorLabel", "")
    return true
  }
  showError("ErrorLabel", "Введеное число не положительное двухзначное")
  return false
}

  async function getPrediction() {
    var token = window.localStorage.getItem('Token');
    const response = await fetch("http://127.0.0.1:8080/Conceive", {
        method: "GET",
        headers: { "Accept": "application/json", "Content-Type": "application/json", "x-token": token },});
    if (response.ok === true) {
        const message = await response.json();
        addPredict(message)
    }
  }

  async function getResult(n) {
    var token = window.localStorage.getItem('Token');
    var x = parseInt(n, 10);
    var raw = JSON.stringify({"number": x});
    const response = await fetch("http://127.0.0.1:8080/Result", {
        method: "POST",
        headers: { "Accept": "application/json", "Content-Type": "application/json", "x-token": token },
        body: raw,
      });
    if (response.ok === true) {
        const message = await response.json();
        addResult(message)
        addHystory(message, x)
    }
  }

  function addResult(message) {
    var dynamicTable = document.getElementById("result-table");
    var rows = dynamicTable.getElementsByTagName("tr");
    var cells = rows[1].getElementsByTagName("td");
    for (var j = 0; j < cells.length; j++) {
      cells[j].innerText = message[j]['reliability'];
    }
  }

  function addPredict(message) {
  var dynamicTable = document.getElementById("predict-table");
  var rows = dynamicTable.getElementsByTagName("tr");
  var cells = rows[1].getElementsByTagName("td");
  for (var j = 0; j < cells.length; j++) {
    cells[j].innerText = message[j]['hypothesis'];
  }
}

function addHystory(message, number) {
  var t = 0
  var dynamicTable = document.getElementById("dynamic-hystory-table");
  var row = document.createElement("tr");
  for (var i = 0; i < message.length; i++) {
    var cell = document.createElement("td");
    if (number === message[i]['hypothesis']) {
      cell.style.backgroundColor = "green";
      t = 1
    }
    cell.innerHTML = message[i]['hypothesis'];
    row.appendChild(cell);
  }
  var cell = document.createElement("td");
  if (t === 1) {
    cell.style.backgroundColor = "green";
  }
  cell.innerHTML = number;
  row.appendChild(cell);
  dynamicTable.appendChild(row);
}

function showError(field, errorMessage) {
	var fieldLabel = document.getElementById(field);
	fieldLabel.innerHTML = errorMessage;
}
  </script>
</body>
</html>
